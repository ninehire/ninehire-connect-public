name: Build Production

on:
  workflow_dispatch:

jobs:
  build-mac:
    runs-on: macos-latest
    # environment: production
    environment: development
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: ninehire/ninehire-connect
          # ref: main
          ref: dev
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: source

      - name: Get version from package.json
        id: get_version
        working-directory: source
        run: |
          VERSION=$(node -p "require('./apps/desktop/package.json').version")
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: v$VERSION"

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        working-directory: source
        run: corepack enable

      - name: Install dependencies
        working-directory: source
        run: yarn install --immutable

      - name: Import Certificate
        env:
          MAC_CERTIFICATE_BASE64: ${{ secrets.MAC_CERTIFICATE_BASE64 }}
          MAC_CERTIFICATE_PASSWORD: ${{ secrets.MAC_CERTIFICATE_PASSWORD }}
        run: |
          echo "$MAC_CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security create-keychain -p "$MAC_CERTIFICATE_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$MAC_CERTIFICATE_PASSWORD" build.keychain
          security import certificate.p12 -k build.keychain -P "$MAC_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$MAC_CERTIFICATE_PASSWORD" build.keychain
          rm certificate.p12

      - name: Build & Notarize
        working-directory: source
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          PROD_URL: ${{ vars.PROD_URL }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          GAMEJOB_DOMAIN: ${{ vars.GAMEJOB_DOMAIN }}
          SARAMIN_DOMAIN: ${{ vars.SARAMIN_DOMAIN }}
          SARAMIN_OLD_DOMAIN: ${{ vars.SARAMIN_OLD_DOMAIN }}
          SARAMIN_API_DOMAIN: ${{ vars.SARAMIN_API_DOMAIN }}
          WANTED_DOMAIN: ${{ vars.WANTED_DOMAIN }}
          WANTED_INTEGRATION_DOMAIN: ${{ vars.WANTED_INTEGRATION_DOMAIN }}
          JOB_KOREA_DOMAIN: ${{ vars.JOB_KOREA_DOMAIN }}
          ALBAMON_DOMAIN: ${{ vars.ALBAMON_DOMAIN }}
          ALBAMON_BFF_COMPANY: ${{ vars.ALBAMON_BFF_COMPANY }}
          SENTRY_ENVIRONMENT: production
        run: yarn dist:mac:local

      - name: Copy artifacts
        run: |
          mkdir -p artifacts
          cp source/apps/desktop/release/*.dmg artifacts/ 2>/dev/null || echo "No DMG files found"
          cp source/apps/desktop/release/*.zip artifacts/ 2>/dev/null || echo "No ZIP files found"
          cp source/apps/desktop/release/latest-mac.yml artifacts/ 2>/dev/null || echo "No latest-mac.yml found"

      - name: Clean source code
        run: rm -rf source

      - uses: actions/upload-artifact@v4
        with:
          name: mac-release
          path: artifacts/*
          retention-days: 30

  build-windows:
    runs-on: windows-latest
    # environment: production
    environment: development
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: ninehire/ninehire-connect
          # ref: main
          ref: dev
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: source

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        working-directory: source
        run: corepack enable

      - name: Install dependencies
        working-directory: source
        run: yarn install --immutable

      - name: Build
        working-directory: source
        env:
          PROD_URL: ${{ vars.PROD_URL }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          GAMEJOB_DOMAIN: ${{ vars.GAMEJOB_DOMAIN }}
          SARAMIN_DOMAIN: ${{ vars.SARAMIN_DOMAIN }}
          SARAMIN_OLD_DOMAIN: ${{ vars.SARAMIN_OLD_DOMAIN }}
          SARAMIN_API_DOMAIN: ${{ vars.SARAMIN_API_DOMAIN }}
          WANTED_DOMAIN: ${{ vars.WANTED_DOMAIN }}
          WANTED_INTEGRATION_DOMAIN: ${{ vars.WANTED_INTEGRATION_DOMAIN }}
          JOB_KOREA_DOMAIN: ${{ vars.JOB_KOREA_DOMAIN }}
          ALBAMON_DOMAIN: ${{ vars.ALBAMON_DOMAIN }}
          ALBAMON_BFF_COMPANY: ${{ vars.ALBAMON_BFF_COMPANY }}
          SENTRY_ENVIRONMENT: production
        run: yarn dist:win:local

      - name: Copy artifacts
        run: |
          mkdir artifacts
          copy source\apps\desktop\release\*.exe artifacts\ 2>nul || echo No EXE files found
          copy source\apps\desktop\release\latest.yml artifacts\ 2>nul || echo No latest.yml found
        shell: cmd

      - name: Clean source code
        run: Remove-Item -Recurse -Force source
        shell: powershell

      - uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: artifacts/*
          retention-days: 30

  create-draft-release:
    needs: [build-mac, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download Mac artifacts
        uses: actions/download-artifact@v4
        with:
          name: mac-release
          path: release-files

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: release-files

      - name: Create Draft Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.build-mac.outputs.version }}
          name: Release ${{ needs.build-mac.outputs.version }}
          draft: true
          prerelease: false
          files: release-files/*
          body: |
            ## ğŸ‰ ë³€ê²½ì‚¬í•­
            <!-- ì—¬ê¸°ì— ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš” -->

            ## ğŸ“¦ ë‹¤ìš´ë¡œë“œ
            - **macOS (Apple Silicon)**: `NinehireConnect-*-arm64.dmg`
            - **Windows (64-bit)**: `NinehireConnect-*-x64.exe`

            ## ğŸ“ ì„¤ì¹˜ ë°©ë²•

            ### macOS
            1. DMG íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            2. DMG íŒŒì¼ ì‹¤í–‰
            3. NinehireConnect ì•±ì„ Applications í´ë”ë¡œ ë“œë˜ê·¸

            ### Windows
            1. EXE íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            2. ì‹¤í–‰í•˜ì—¬ ì„¤ì¹˜ ë§ˆë²•ì‚¬ ì§„í–‰

            ---

            **ë²„ì „:** ${{ needs.build-mac.outputs.version }}  
            **ë¹Œë“œ ë‚ ì§œ:** ${{ github.event.repository.updated_at }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "âœ… Draft Release Created: ${{ needs.build-mac.outputs.version }}"
          echo "ğŸ“ Please review and publish the release manually"
